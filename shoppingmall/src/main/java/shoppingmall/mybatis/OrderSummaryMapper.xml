<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="OrderSummary">
	<sql id="columns">
		order_summary_id, ordered_at, total_price, final_price, payment_type, point_used, member_id, status_id, delivery_id
	</sql>

	<!-- join을 통한 주문 요약 조회 -->
	<resultMap id="DetailJoin" type="OrderSummary">
		<id column="order_summary_id" property="order_summary_id" />
		<result column="ordered_at" property="ordered_at" />
		<result column="total_price" property="total_price" />
		<result column="final_price" property="final_price" />
		<result column="payment_type" property="payment_type" />
		<result column="point_used" property="point_used" />

		<association column="member_id" property="member" javaType="Member" select="Member.select" />
		<association column="status_id" property="status" javaType="Status" select="Status.select" />
		<association column="delivery_id" property="delivery" javaType="Delivery" select="Delivery.select" />
			
		<collection column="order_summary_id"  property="orderDetailList" javaType="java.util.List" ofType="OrderDetail" select="OrderDetail.selectByOrderSummaryId"/>
	</resultMap>
	
	<!-- 한 건 조회 -->
	<select id="select" parameterType="int" resultMap="DetailJoin">
	  SELECT <include refid="columns"/> FROM order_summary
	  WHERE order_summary_id = #{order_summary_id}
	</select>
	
	<!-- 배송 관련 주문 요약 목록 조회 -->
	<select id="selectOrders" parameterType="map" resultType="OrderSummary">
	  SELECT <include refid="columns"/> FROM order_summary WHERE member_id = #{member_id} AND status_id IN (1,2,3,4,5) AND ordered_at BETWEEN #{startDate} AND #{endDate} ORDER BY ordered_at DESC
	</select>
	
	<!-- 취소·반품, 교환 관련 주문 요약 목록 조회 -->
	<select id="selectProblematic" parameterType="map" resultType="OrderSummary">
	  SELECT <include refid="columns"/> FROM order_summary WHERE member_id = #{member_id} AND status_id IN (6,7) AND ordered_at BETWEEN #{startDate} AND #{endDate} ORDER BY ordered_at DESC
	</select>
	
	<!-- 배송 / 취소·반품, 교환 (상세 내역 포함) 목록 조회 -->
	<select id="selectByStatusList" parameterType="map" resultMap="DetailJoin">
		SELECT <include refid="columns"/> FROM order_summary 
		WHERE order_summary_id = #{order_summary_id} AND member_id = #{member_id}
		<if test="statusList != null and statusList.size() > 0"> AND status_id IN
		  <foreach item="id" collection="statusList" open="(" separator="," close=")">
		    #{id}
		  </foreach>
		</if> 
		ORDER BY ordered_at DESC
	</select>
	
	<!-- 회원명을 통한 조회 -->
	<select id="selectByMember" parameterType="Member" resultMap="DetailJoin">
		SELECT <include refid="columns"/> FROM order_summary WHERE member_id = #{member_id}
	</select>
	
	<!-- 주문요약 추가 -->
	<insert id="insert" parameterType="OrderSummary">
		INSERT INTO order_summary(total_price, final_price, payment_type, point_used, member_id, status_id, delivery_id) 
		VALUES(#{total_price}, #{final_price}, #{payment_type}, #{point_used}, #{member.member_id}, #{status.status_id}, #{delivery.delivery_id})
	</insert>

	<!-- 주문요약 수정 -->
	<update id="update" parameterType="OrderSummary">
		UPDATE order_summary SET
		total_price=#{total_price}, final_price=#{final_price}, payment_type=#{payment_type}, point_used=#{point_used}, status_id=#{status.status_id}, delivery_id=#{delivery.delivery_id}
		WHERE order_summary_id = #{order_summary_id};
	</update>

	<!-- 주문요약 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM order_summary WHERE order_summary_id = #{order_summary_id}
	</delete>
	
	<!-- 회원FK를 통한 주문요약 삭제 -->
	<delete id="deleteByMemberId" parameterType="int">
		DELETE FROM order_summary WHERE member_id = #{member_id}
	</delete>

</mapper>